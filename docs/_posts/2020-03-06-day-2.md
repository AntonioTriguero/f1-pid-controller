---
title: "Day 2-3. P Controller Version"
date: 2020-03-06T11:13:00-04:00
categories:
  - logbook
tags:
  - log
  - update
---

Para este post pretendo mostrar un primer controlador proporcional cuyo objetivo es recorrer el circuito siguiendo la linea a una velocidad constante y sin tener en cuenta la rapidez pero si la precisión y seguridad de la conducción.

# Algoritmo

El algoritmo se basa en un bucle infinito en el que cada iteracción ejecuta tres tareas principales de forma secuencial:

1. Captura de una imágen del estado actual y procesamiento de la misma.
2. Obtener la velocidad de giro para dicho estado.
3. Ordenar dicha información a los motores.

Opcionalmente, aunque muy recomendable, el sistema permite mostrar al final de cada iteración una imagen. Dicha imagen puede contener
la imagen capturada junto con ciertos elementos que indiquen como se ha ido procesando la imagen (segmentación por colores, dibujado, etc)

## Procesamiento de la imagen

Para poder sacar información que aporte valor para el algoritmo es necesario hacer un procesamiento de la misma. Este procesamiento se realizará con un módulo de Python llamado OpenCV muy conocido en el mundo de la visión por computador. Este módulo ya viene incluido dentro de la herramienta Robotics Academy tanto en Unibotics (web) como en local.

En esta primera versión se ha decido obtener dos datos a partir de la imagen:
- Centro de la linea roja dada una altura.
- Centro de la imagen dada una altura.

En este caso interesa obtener ambas medidas dadas una misma altura para más tarde poder ejecutar la función de error. La obteneción del centro de la imagen dada una altura se puede obtener de forma trivial mediante Numpy y OpenCV por lo que procedo a explicar como se ha obtenido el centro de la linea a una altura dada.

### Centro de la linea roja dada una altura

La ventaja que ofrece este problema dentro del simulador Gazebo es que la linea es roja en todo su recorrido y no hay ningún elemento rojo adicional dentro del entorno. De esta manera se puede realizar una segmentación por color y obtener una imagen con todos los elementos rojos dentro de la misma. Esto se puede realizar fácil en OpenCV con la función [`inRange()`](https://docs.opencv.org/3.4/da/d97/tutorial_threshold_inRange.html). Debido a que el rango de valores BGR no es trivial para realizar la segmentación, se ha procedido a desarrollar una herramienta que permita seleccionar dichos valores con una interfaz gráfica en OpenCV a la vez que se observa el resultado. 

![Color Segmentation Tool](/docs/assets/images/color-segmentation.png "Color Segmentation Tool")